name: Microservice Evolution Pipeline

on:
  push:
    branches:
      - 'feature/**'
      - 'hotfix/**'
      - 'release/**'
      - 'copilot/**'
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  checks: write
  statuses: write

env:
  NODE_VERSION: '20.x'

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      client-changed: ${{ steps.changes.outputs.client }}
      server-changed: ${{ steps.changes.outputs.server }}
      shared-changed: ${{ steps.changes.outputs.shared }}
      tools-changed: ${{ steps.changes.outputs.tools }}
      tests-changed: ${{ steps.changes.outputs.tests }}
      docs-changed: ${{ steps.changes.outputs.docs }}
      any-code-changed: ${{ steps.changes.outputs.any-code }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect file changes
        id: changes
        run: |
          # Get changed files
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git ls-files)
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Detect changes by area
          CLIENT_CHANGED="false"
          SERVER_CHANGED="false"
          SHARED_CHANGED="false"
          TOOLS_CHANGED="false"
          TESTS_CHANGED="false"
          DOCS_CHANGED="false"
          
          echo "$CHANGED_FILES" | while read -r file; do
            case "$file" in
              client/*) echo "client=true" >> $GITHUB_OUTPUT ;;
              server/*) echo "server=true" >> $GITHUB_OUTPUT ;;
              shared/*) echo "shared=true" >> $GITHUB_OUTPUT ;;
              tools/*) echo "tools=true" >> $GITHUB_OUTPUT ;;
              test/*) echo "tests=true" >> $GITHUB_OUTPUT ;;
              docs/*) echo "docs=true" >> $GITHUB_OUTPUT ;;
            esac
          done
          
          # Check if any code changed (not just docs)
          CODE_FILES=$(echo "$CHANGED_FILES" | grep -E '\.(ts|tsx|js|jsx|json|yml|yaml)$' | grep -v '^docs/' || true)
          if [ -n "$CODE_FILES" ]; then
            echo "any-code=true" >> $GITHUB_OUTPUT
          else
            echo "any-code=false" >> $GITHUB_OUTPUT
          fi
          
          # Set defaults if not set
          echo "client=${CLIENT_CHANGED:-false}" >> $GITHUB_OUTPUT
          echo "server=${SERVER_CHANGED:-false}" >> $GITHUB_OUTPUT
          echo "shared=${SHARED_CHANGED:-false}" >> $GITHUB_OUTPUT
          echo "tools=${TOOLS_CHANGED:-false}" >> $GITHUB_OUTPUT
          echo "tests=${TESTS_CHANGED:-false}" >> $GITHUB_OUTPUT
          echo "docs=${DOCS_CHANGED:-false}" >> $GITHUB_OUTPUT

  qa-pipeline:
    name: Quality Assurance
    needs: detect-changes
    if: needs.detect-changes.outputs.any-code-changed == 'true' || github.event_name == 'pull_request'
    uses: ./.github/workflows/reusable-qa.yml
    with:
      node-version: '20.x'
      run-tests: true
      run-lint: true
      run-build: true
      upload-coverage: ${{ github.event_name == 'pull_request' }}

  server-tests:
    name: Server Integration Tests
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.server-changed == 'true' || needs.detect-changes.outputs.shared-changed == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run server tests
        run: npm run test:run -- test/server/

      - name: Server test summary
        run: |
          echo "## Server Tests" >> $GITHUB_STEP_SUMMARY
          echo "Server integration tests completed successfully." >> $GITHUB_STEP_SUMMARY

  client-tests:
    name: Client Unit Tests
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.client-changed == 'true' || needs.detect-changes.outputs.shared-changed == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run client tests
        run: npm run test:run -- test/components/ test/utils/
        continue-on-error: true

      - name: Client test summary
        run: |
          echo "## Client Tests" >> $GITHUB_STEP_SUMMARY
          echo "Client unit tests completed." >> $GITHUB_STEP_SUMMARY

  mergeability-check:
    name: Mergeability Assessment
    runs-on: ubuntu-latest
    needs: [qa-pipeline, server-tests, client-tests]
    if: always() && github.event_name == 'pull_request'
    outputs:
      is-mergeable: ${{ steps.assess.outputs.is-mergeable }}
      merge-blockers: ${{ steps.assess.outputs.blockers }}

    steps:
      - name: Assess mergeability
        id: assess
        run: |
          BLOCKERS=""
          IS_MERGEABLE="true"
          
          # Check QA pipeline
          if [ "${{ needs.qa-pipeline.outputs.test-passed }}" != "true" ]; then
            BLOCKERS="$BLOCKERS,Tests failed"
            IS_MERGEABLE="false"
          fi
          
          if [ "${{ needs.qa-pipeline.outputs.build-passed }}" != "true" ]; then
            BLOCKERS="$BLOCKERS,Build failed"
            IS_MERGEABLE="false"
          fi
          
          # Check if it's a draft PR
          if [ "${{ github.event.pull_request.draft }}" = "true" ]; then
            BLOCKERS="$BLOCKERS,PR is still a draft"
            IS_MERGEABLE="false"
          fi
          
          # Remove leading comma
          BLOCKERS="${BLOCKERS#,}"
          
          echo "is-mergeable=$IS_MERGEABLE" >> $GITHUB_OUTPUT
          echo "blockers=$BLOCKERS" >> $GITHUB_OUTPUT
          
          echo "## Mergeability Assessment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$IS_MERGEABLE" = "true" ]; then
            echo "âœ… **This PR is ready to merge**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **This PR has merge blockers:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "$BLOCKERS" | tr ',' '\n' | while read -r blocker; do
              if [ -n "$blocker" ]; then
                echo "- $blocker" >> $GITHUB_STEP_SUMMARY
              fi
            done
          fi

      - name: Add PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const isMergeable = '${{ steps.assess.outputs.is-mergeable }}' === 'true';
            const blockers = '${{ steps.assess.outputs.blockers }}';
            
            let body = '## ðŸ¤– Automated Mergeability Check\n\n';
            
            if (isMergeable) {
              body += 'âœ… **All checks passed!** This PR is ready for review and merge.\n';
            } else {
              body += 'âŒ **Merge blockers detected:**\n\n';
              blockers.split(',').forEach(blocker => {
                if (blocker.trim()) {
                  body += `- ${blocker.trim()}\n`;
                }
              });
              body += '\nPlease address these issues before merging.';
            }
            
            body += '\n\n---\n*This comment was automatically generated by the Microservice Evolution Pipeline.*';
            
            // Find existing bot comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Automated Mergeability Check')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  evolution-report:
    name: Evolution Report
    runs-on: ubuntu-latest
    needs: [detect-changes, qa-pipeline, mergeability-check]
    if: always()

    steps:
      - name: Generate evolution report
        run: |
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          echo "## Microservice Evolution Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $TIMESTAMP" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Changed Components" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Client | ${{ needs.detect-changes.outputs.client-changed || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Server | ${{ needs.detect-changes.outputs.server-changed || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Shared | ${{ needs.detect-changes.outputs.shared-changed || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tools | ${{ needs.detect-changes.outputs.tools-changed || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.detect-changes.outputs.tests-changed || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docs | ${{ needs.detect-changes.outputs.docs-changed || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Quality Gates" >> $GITHUB_STEP_SUMMARY
          echo "| Gate | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.qa-pipeline.outputs.test-passed || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.qa-pipeline.outputs.build-passed || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Mergeable | ${{ needs.mergeability-check.outputs.is-mergeable || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
